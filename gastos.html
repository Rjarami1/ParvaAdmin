<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gastos</title>
</head>
<body>
    <h2>Gastos</h2><br>
    <br>

    <form>
        <label for="expense_date">Fecha: </label>
        <input type="date" name="expense_date" id="expense_date">&nbsp;&nbsp;

        <label for="expense_type">Tipo Gasto:</label>
        <select name="expense_type" id="expense_type">
            <option value="" selected></option>
        </select><br>

        <label for="expense_code">Código Gasto</label>
        <input type="text" name="expense_code" id="expense_code">&nbsp;&nbsp;

        <label for="expense_description">Descripción:</label>
        <input type="text" name="expense_description" id="expense_description" disabled><br>

        <label for="expense_value">Valor:</label>
        <input type="number" name="expense_value" id="expense_value">&nbsp;&nbsp;
        
        <label for="expense_quantity">Cantidad:</label>
        <input type="number" name="expense_quantity" id="expense_quantity">
        <br><br>

        <button type="submit" id="add_expenses">Adicionar Gasto</button>
        <br>

        <p id="error_msg" style="color: red;"></p>

        <h3>Gastos Adicionados:</h3><br>
        <table id="expenses_to_register">
        </table>
        <br>
        
    </form>

    <button id="save_expenses">Registrar Gastos</button>

    <script>
        //Importando electron
        const {ipcRenderer} = require('electron');

        //Declarando los elementos del DOM
        const date = document.querySelector('#expense_date');
        const type = document.querySelector('#expense_type');
        const code = document.querySelector('#expense_code');
        const description = document.querySelector('#expense_description');
        const value = document.querySelector('#expense_value');
        const quantity = document.querySelector('#expense_quantity');
        const form = document.querySelector('form');
        const error_msg = document.querySelector('#error_msg');

        //Evento para cuando la página termine de cargar y poder modificarla
        document.addEventListener('DOMContentLoaded', (e) => {

            //Inicializa un objeto de fecha
            var today = new Date();
            
            //Si el día es de un solo dígito se antepone un cero (Para seguir el formato de fecha)
            var day = today.getDate().toString();
            if(day.length < 2){
                day = `0${day}`;
            }

            //Si el mes es de un solo digito se antepone un cero (Para seguir el formato de fecha)
            var month = today.getMonth()+1
            month = month.toString();
            if(month.length < 2){
                month = `0${month}`
            }

            //Se asigna la fecha al campo de fecha en el formulario para generar la fecha
            //de hoy automáticamente
            var auto_date = today.getFullYear()+'-'+month+'-'+day;
            date.value = auto_date;

            //Se le avisa al proceso principal (main) que la página está lista para utilizarse
            ipcRenderer.send('expense:ready');
        })

        //Inicialización de variables que contendrán los tipos de gastos y códigos que hay en la base de datos
        let exp_types;
        let exp_codes;
        ipcRenderer.on('expense:info', (e, arr) => {
            exp_types = arr[0];
            exp_codes = arr[1];

            //Se alimenta la lista de selección del formulario con los tipos de gastos que existen en la BD
            let option;
            exp_types.forEach(exp_type => {
                option = document.createElement('option');
                option.value = exp_type.type_id;
                option.textContent = exp_type.type_description;

                type.appendChild(option);
            });
        })

        //Evento que se registra cuando se agregan códigos en el formulario
        let codeValue;
        let type_value;
        code.addEventListener('input', (e) => {
            e.preventDefault();

            //Esta parte busca si el código ingresado por el usuario coincide con algún código existente
            //en la base de datos que tenga el mismo tipo (type) seleccionado en la lista de selección.
            description.value = '';
            if(type.options[type.selectedIndex].value != ""){
                type_value = type.options[type.selectedIndex].value;
                codeValue = code.value;

                //Si existe el código imprime la descripción de este en el campo de descripción que es
                //de sólo lectura
                exp_codes.forEach(exp_code => {
                    if(exp_code.expense_type_id == type_value){
                        if(exp_code.expense_code.trim() == codeValue){
                            description.value = exp_code.code_description.trim();
                        }
                    }
                });
            }
        })

        let added_expenses = [];
        let expense_obj;
        form.addEventListener('submit', (e) => {
            e.preventDefault();

            if(date.value != "" && type.options[type.selectedIndex].value != "" && code.value != "" && description.value != "" && value.value != "" && quantity.value != ""){
                expense_obj = {
                    date: date.value,
                    type: type.options[type.selectedIndex].value,
                    code: code.value,
                    description: description.value,
                    value: parseInt(value.value),
                    quantity: parseInt(quantity.value)
                }
                
                added_expenses.push(expense_obj);
                code.value = '';
                description.value = '';
                value.value = '';
                quantity.value = '';
                error_msg.textContent = "";

                display_added_expenses();
            }
            else{
                error_msg.textContent = "";
                error_msg.textContent = 'Debe ingresar todos los campos.\n';

                if(description.value == ""){
                    error_msg.textContent += 'El código ingresado no esta asociado al tipo de gasto seleccionado.\n';
                }
                if(parseInt(quantity.value) <= 0){
                    error_msg.textContent += 'La cantidad del gasto no puede ser menor o igual a cero.';
                }
            }


        })

        //Cada vez que se cambie el tipo de gasto se resetean los campos de código y descripción
        type.addEventListener('change', (e) => {
            e.preventDefault();

            code.value = '';
            description.value = '';
        })

        function display_added_expenses(){
            //Imprimir gastos que se han adicionado
        }

    </script>

</body>
</html>