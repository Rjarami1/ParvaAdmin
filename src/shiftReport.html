<!DOCTYPE html>
<html lang="es">

<head>
    <!-- Bootstrap 4 CSS -->
    <link rel="stylesheet" href="../dependencies/bootstrap-4.4.1-dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="styles/stilosDaniel.css" />

    <meta charset="UTF-8">
    <title>Reporte de Turno</title>
</head>

<body>

    <div class="encabezadoPrinSup">
        <h1 class="margLeftTitulos">Reporte de Turno</h1>
    </div>

    <div class="encabezadoPrinInf">
        <h2 id="fecha" class="margLeftTitulos encabezadoPrinInflet"></h2>
    </div>


    <div class="container centralRepTurnos">

        <div class="row">

            <div class="col-xl-3">

                <form id="filters">
                    <div class="row">

                        <label class="formRepGastos" for="fromDate">Desde: </label>
                        <input type="date" class="form-control" name="fromDate" id="fromDate">

                        <label class="formRepGastos" for="toDate">Hasta: </label>
                        <input type="date" class="form-control" name="toDate" id="toDate">

                        <label class="formRepGastos" for="salesman">Vendedor: </label>
                        <select class="form-control" name="salesman" id="salesman">
                            <option value="-1">--- Seleccione ---</option>
                        </select>

                        <label class="formRepGastos" for="shiftID">ID Turno:</label>
                        <input type="number" class="form-control" name="shiftID" id="shiftID">

                    </div>

                    <div class="row formRepGastos">
                        <div class="col-xl-5">
                            <button class="btnBuscarGasto btn btn btn-primary " type="submit">Buscar</button>
                        </div>

                        <div class="col-xl-7">
                            <button class="btnGenerarCsv btn btn btn-primary " type="button">Generar CSV</button>
                        </div>

                        <div class="formRepGastos">
                            <p id="msg" style="color: red;"></p>
                        </div>
                    </div>

                </form>

            </div>

            <div class="col-xl-9">

                <div class="row tablaRepTurn">
                    <table class="table table-striped" id="shifts">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Fecha y Hora Inicio</th>
                                <th>Fecha y Hora Fin</th>
                                <th>ID Turno</th>
                                <th>Estado</th>
                                <th>Total Ventas</th>
                                <th>Vendedor</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                </div>

                <div class="row">
                    <p id="msg_result"></p>
                </div>

            </div>
        </div>
    </div>


    <!-- Importando funciones de utilidades -->
    <script src=" ../utilidades.js"></script>

    <script>
        window.$ = window.jQuery = require('jquery');
        const { ipcRenderer } = require('electron');
        const { _ } = require('lodash');

        //Informar al Main Renderer que la página está lista para inicializar la función setAutoTime.
        document.addEventListener('DOMContentLoaded', (e) => {
            setAutoTime();
        })

        // Declarando función setAutoTime
        function setAutoTime() {
            $('#fecha').text(dateTimeClock());
            setTimeout('setAutoTime()', 1000);
        }

        $(document).ready(function () {

            ipcRenderer.send('shiftReport:ready');

            let salesmen;
            ipcRenderer.on('shiftReport:info', (e, arr) => {
                salesmen = arr;

                salesmen.forEach(salesman => {
                    $('#salesman').append(`<option value="${salesman.name.trim()}">${salesman.name.trim()}</option>`);
                });

                $('#filters').on('submit', function (e) {
                    e.preventDefault();
                    return searchShifts(1);
                });

                $('.btnGenerarCsv').click(function (e) {
                    e.preventDefault();

                    return searchShifts(2);
                })

            });

            ipcRenderer.on('shiftReport:result', (e, arr) => {
                if (arr.length > 0) {

                    $('#msg_result').text('');
                    let num = 1;
                    let shift_start_date, shift_end_date;

                    arr.forEach(shift => {
                        shift_start_date = new Date(Date.parse(shift.shift_start));
                        shift_end_date = new Date(Date.parse(shift.shift_end));

                        if(shift_end_date == 'Invalid Date'){
                            shift_end_date = '-'
                        }
                        else{
                            shift_end_date = shift_end_date.toLocaleString();
                        }

                        $('#shifts tbody').append(`<tr><td>${num}</td><td>${shift_start_date.toLocaleString()}</td><td>${shift_end_date}</td><td>${shift.shift_id}</td><td>${shift.shift_status}</td><td>${formatCurrency(parseInt(shift.total_shift))}</td><td>${shift.name}</td></tr>`);
                        num++;

                        shift_start_date = null;
                        shift_end_date = null;
                    });
                }
                else {
                    $('#msg_result').text('No se encontraron registron que cumplan con el criterio de búsqueda.');
                }
            });

            function searchShifts(option) {
                let filterObj = buildQueryFilter();

                if (filterObj != null)
                    ipcRenderer.send('shiftReport:search', [filterObj, option]);
            }

            function buildQueryFilter() {
                let filterObject = null;

                if ($('#fromDate').val() != "" || $('#toDate').val() != "" || $('#salesman').val() != "-1" || $('#shiftID').val() != "") {

                    $('#shifts tbody').empty();
                    $('#msg').text('');

                    let salesmanText;

                    if ($('#salesman').val() == "-1") {
                        salesmanText = "";
                    }
                    else {
                        salesmanText = $('#salesman option:selected').val();
                    }

                    filterObject = {
                        fromDate: $('#fromDate').val(),
                        toDate: $('#toDate').val(),
                        shift: $('#shiftID').val(),
                        salesman: salesmanText
                    };
                }
                else {
                    $('#msg').text('Debe seleccionar por lo menos un filtro.');
                }

                return filterObject;
            }

        })
    </script>

    </script>
    <!-- jQuery library -->
    <script src="../dependencies/bootstrap-4.4.1-dist/js/jQuery.js"></script>

</body>

</html>