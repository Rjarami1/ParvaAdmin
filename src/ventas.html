<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Bootstrap 4 CSS -->
    <link rel="stylesheet" href="../dependencies/bootstrap-4.4.1-dist/css/bootstrap.min.css" />

    <meta charset="UTF-8">
    <title>Ventas</title>
</head>

<style>

header {
    margin-bottom: 30px;
    padding-left: 20px;
}

button.numpad {
    width: 80px;
    height: 80px;
    font-size: 30px;
    margin: 4px;
}

input#dateTime{
    width: 230px;
}

button.limpiar {
    font-size: 20px;
}

.foot {
    margin-top: 30px;
    margin-bottom: 10px;
}

.endButton {
    width: 300px;
    height: 50px;
    font-weight: bold;
}

.endButton#complete {
    background-color: lightblue;
}

.endButton#register {
    background-color: lightgreen;
}

div.shiftButtons {
    text-align: center;
}

</style>

<body>
    <header>
        <h1>Ventas</h1><br>
        <h3>Módulo de registro de ventas</h3>
    </header>

    <div class="container">
        <div class="row shiftButtons">
            <div class="col">
                <button id="startShift">Iniciar Turno</button>
                <button id="endShift">Finalizar Turno</button>
            </div>
        </div>
    </div>

    <div class="container chart">
        <div class="row">
            <div class="col">
                <form id="form1">
                    <label for="dateTime">Fecha y Hora: </label><br>
                    <input type="text" name="dateTime" id="dateTime" disabled><br>
                
                    <label for="productCode">Código del Producto</label><br>
                    <input name="productCode" type="number" id="productCode">&nbsp;&nbsp;
                    <input type="text" id="productDesc" disabled><br>
                    <input type="hidden" name="hiddenId" id="hiddenId">
            
                    <label for="productValue">Valor</label><br>
                    <input type="text" name="productValue" id="productValue" disabled><br>
            
                    <label for="quantity">Cantidad</label><br>
                    <input type="number" name="quantity" id="quantity"><br>
            
                    <label for="total">Total</label><br>
                    <input type="text" name="total" id="total" disabled><br>

                    <label for="paysWith">Paga con:</label><br>
                    <input type="number" name="paysWith" id="paysWith"><br>

                    <label for="change">Devuelta:</label><br>
                    <input type="text" name="change" id="change" disabled><br>
                </form>
            </div>
            <div class="col">
                <button class="numpad" value="1">1</button>
                <button class="numpad" value="2">2</button>
                <button class="numpad" value="3">3</button><br>
                <button class="numpad" value="4">4</button>
                <button class="numpad" value="5">5</button>
                <button class="numpad" value="6">6</button><br>
                <button class="numpad" value="7">7</button>
                <button class="numpad" value="8">8</button>
                <button class="numpad" value="9">9</button><br>
                <button class="numpad" value="0">0</button>
                <button class="numpad" value="00">00</button>
                <button class="numpad" value="000">000</button><br>
                <button class="numpad" value="-1">Enter</button>
                <button class="numpad limpiar" value="-2">Limpiar</button>
            </div>
            <div class="col">
                <button id="deleteProd">Eliminar Producto</button><br>
                <select id="regProducts" name="regProducts" size="5">
                </select>
            </div>
        </div>
        <div class="row foot">
            <div class="col">
                <button class="endButton" id="complete">Completar Venta</button>
            </div>
            <div class="col">
                <button class="endButton" id="register">Registrar Venta</button>
            </div>
        </div>
    </div>

    <script src="../utilidades.js"></script>

    <script>
        const {ipcRenderer} = require('electron');
        const {_} = require('lodash');
        window.$ = window.jQuery = require('jquery');

        $(document).ready(() => {
            
            setAutoTime();

            $('.chart').hide();
            $('#startShift').hide();
            $('#endShift').hide();

            let currentInput = 'productCode';

            $('#productCode').focus(setCurrentInput);
            $('#quantity').focus(setCurrentInput);
            $('#paysWith').focus(setCurrentInput);

            $('.numpad').click(addKey);
            $('#deleteProd').click(removeProduct);
            $('#complete').click(completeSale);
            $('#register').click(registerSale);
            $('#startShift').click(startShift);
            $('#endShift').click(endShift);

            ipcRenderer.send('sales:ready');

            let products = [];
            ipcRenderer.on('sales:info', (e,arr) => {
                products = arr[0];
                if(arr[1]){
                    $('.chart').show();
                    $('#endShift').show();
                    $('#startShift').hide();
                }
                else{
                    $('#startShift').show();
                    $('.chart').hide();
                    $('#endShift').hide();
                }

                $('#productCode').on('input',compareCode);
            });

            ipcRenderer.on('sales:started', e => {
                $('.chart').show();
                $('#endShift').show();
                $('#startShift').hide();
            });

            ipcRenderer.on('sales:ended', e => {
                $('.chart').hide();
                $('#endShift').hide();
                $('#startShift').show();

                console.log('Shift ended');
            })

            let regId = 0;
            let productSaleList = [];
            let total = 0;
            function addKey(){
                let $this = $(this),
                    input = $(`#${currentInput}`),
                    value = input.val();

                if($this.val() == "-1"){
                    switch(currentInput){
                        case 'productCode':
                            $('#quantity').focus();
                            break;

                        case 'quantity':
                            if($('#productDesc').val() != "" && $('#quantity').val() != ""){
                                
                                $('#regProducts').append(`<option id="${regId}">${$('#quantity').val()}  |  ${$('#productDesc').val()}  |  ${$('#productValue').val()}</option>`);
                                productSaleList.push({
                                    local_id: regId,
                                    prod_id: $('hiddenId').val(),
                                    quantity: parseInt($('#quantity').val()),
                                    value: parseInt($('#productValue').val().replace(',','').slice(1))
                                });
                                regId++;
                                total += parseInt($('#productValue').val().replace(',','').slice(1)) * parseInt($('#quantity').val());
                            }
                            $('#total').val(formatCurrency(total));
                            $('#productCode').val('');
                            $('#quantity').val('');
                            $('#productDesc').val('');
                            $('#productValue').val('');
                            $('#paysWith').val('');
                            $('#change').val('');
                            $('#productCode').focus();
                            break;

                        case 'paysWith':
                            $('#change').val(formatCurrency(parseInt($('#paysWith').val()) - total));
                            $('#productCode').focus();
                            break;
                    }
                }
                else if($this.val() == "-2"){
                    input.val('');
                    if(currentInput == 'productCode'){
                        $('#productDesc').val('');
                        $('#productValue').val('');
                    }
                }
                else{
                    input.val(value + $this.val());
                    if(currentInput == 'productCode'){
                        compareCode();
                    }
                }
            }

            function setCurrentInput(){
                let $this = $(this);
                currentInput = $this.attr('id')
            }

            function compareCode(){
                let $this = $('#productCode'),
                    currentVal = $this.val(),
                    prodObj = _.find(products, n => {
                        return n.code_prod == currentVal;
                    });

                if(prodObj != undefined){
                    $('#productDesc').val(prodObj.name_prod);
                    $('#productValue').val(prodObj.val_prod);
                    $('#hiddenId').val(prodObj.product_id);
                }
                else{
                    $('#productDesc').val('');
                    $('#productValue').val('');
                }  
            }

            function removeProduct(){
                let id = $('#regProducts option:selected').attr('id');
                let obj;
                if(id != undefined){
                    $(`#regProducts #${id}`).remove();
                    obj = _.remove(productSaleList, n => {
                        return n.local_id == id;
                    })
                    
                    total -= obj[0].value * obj[0].quantity;
                    $('#total').val(formatCurrency(total));
                    $('#change').val('');
                    $('#paysWith').val('');
                    $('#productCode').focus();
                }
            }

            function completeSale(){
                $('#paysWith').focus();
            }

            function registerSale(){
                if(productSaleList.length > 0){
                    ipcRenderer.send('sales:register', productSaleList);
                }
            }

            function startShift(){
                ipcRenderer.send('sales:start');
            }

            function endShift(){
                ipcRenderer.send('sales:end');
            }
        })

        function setAutoTime(){
            $('#dateTime').val(dateTimeClock());
            setTimeout('setAutoTime()',1000);
        } 
    </script>

    <!-- jQuery library -->
    <script src="../dependencies/bootstrap-4.4.1-dist/js/jQuery.js"></script>
    
</body>
</html>